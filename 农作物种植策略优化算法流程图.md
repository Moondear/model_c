flowchart LR
 subgraph INPUT["输入数据层"]
        A1["附件1：54个地块信息"]
        A2["附件2：41种作物数据"]
        A3["7类种植约束"]
  end
 subgraph PREP["数据预处理"]
        B1["地块分类：粮食/水浇/大棚"]
        B2["作物参数：产量·成本·价格"]
        B3["兼容矩阵：54×41地块-作物关系"]
  end
 subgraph ALGO1["粮食地块(26个)"]
        D1["动态规划算法"]
        D1_1["状态：年份/作物/豆类计数"]
        D1_2["状态转移方程"]
        D1_3["记忆化搜索求解"]
  end
 subgraph ALGO2["水浇地(8个)"]
        D2["混合整数规划"]
        D2_1["面积决策变量"]
        D2_2["0-1种植指示变量"]
        D2_3["Gurobi求解器"]
  end
 subgraph ALGO3["大棚(20个)"]
        D3["贪心算法"]
        D3_1["按收益排序作物"]
        D3_2["约束条件筛选"]
        D3_3["局部最优选择"]
  end
 subgraph SOL["解决方案"]
        E1["粮食地块7年计划"]
        E2["水浇地7年计划"]
        E3["大棚7年计划"]
  end
 subgraph VALID["约束验证"]
        G1{"重茬约束"}
        G2{"豆类轮作"}
        G3{"面积限制"}
        G4{"适应性匹配"}
  end
 subgraph CALC["收益计算"]
        H1["情景1：超产滞销"]
        H2["情景2：折价50%"]
        H3["收益提升分析"]
  end
 subgraph OUTPUT["输出结果"]
        I1["情景1种植计划"]
        I2["情景2种植计划"]
        I3["优化报告"]
  end
    A1 --> B1
    A2 --> B2
    A3 --> B3
    B1 --> C1["分层分治策略"]
    B2 --> C1
    B3 --> C1
    C1 --> ALGO1 & ALGO2 & ALGO3
    D1_3 --> E1
    D2_3 --> E2
    D3_3 --> E3
    E1 --> F1["全局方案整合"]
    E2 --> F1
    E3 --> F1
    F1 --> G1 & G2 & G3 & G4
    G1 --> H1
    G2 --> H1
    G3 --> H2
    G4 --> H2
    H1 --> I1 & H3
    H2 --> I2 & H3
    H3 --> I3

    C1@{ shape: hex}
    linkStyle 10 stroke:#000000,fill:none




    flowchart TB
  %% 输入与参数
  A1[["附件1.xlsx<br/>土地/作物基础数据"]]:::io
  A2[["附件2.xlsx<br/>2023统计与价格/产量/成本区间"]]:::io
  A3[["参数设定<br/>α, λ, N_saa, N_mc, 波动区间, 价格增速"]]:::store

  %% 情景生成与抽样
  subgraph SG1["情景生成与抽样"]
    direction TB
    S1["Monte Carlo 生成 N=1000 情景<br/>Y, P, D, C 随机/增长"]:::process
    S2["代表情景选择 SAA（30–50）"]:::process
    S3{"是否启用<br/>尾部情景增约?"}:::decision
  end

  %% 建模与求解
  subgraph SG2["建模与求解"]
    direction TB
    subgraph 建模["随机规划建模（PuLP/CBC）"]
      M0["构建 PuLP 模型"]:::process
      M1["决策变量<br/>x_{i,j,t,s}, q_sell, q_excess, τ(VaR)"]:::store
      M2["目标函数：max E[Profit] − λ·CVaR"]:::process
      M3["关键约束：产销平衡/地块容量/轮作规则"]:::process
    end
    
    subgraph 求解["求解"]
      O1["CBC 求解<br/>timeLimit=1200, threads=4"]:::process
      O2{"求解成功?"}:::decision
      O3["提取解：种植方案与情景收益"]:::process
      O4["失败回退：调整参数"]:::process
    end
  end

  %% 验证与输出
  subgraph SG3["验证与输出"]
    direction TB
    subgraph 验证["验证与稳健性"]
      V1["1000 情景后验仿真"]:::process
      V2["计算：E[Profit], Std, VaR5%, CVaR5%"]:::process
      V3{"尾部风险偏高?"}:::decision
      V4["加入最差情景<br/>重新抽样"]:::process
    end
    
    subgraph 输出["结果输出"]
      R1["写入 result2.xlsx"]:::result
      R2["生成收益分布图"]:::result
      R3["记录求解统计"]:::result
    end
  end

  %% 连接线
  A1 --> SG1
  A2 --> SG1
  A3 --> SG1
  SG1 -->|情景数据| SG2
  
  SG1 --> S1 --> S2 --> S3
  S3 -->|是/否| M0
  
  建模 --> M0 --> M1 --> M2 --> M3 --> O1
  求解 --> O1 --> O2
  O2 -->|是| O3 --> SG3
  O2 -->|否| O4 --> SG1
  
  验证 --> V1 --> V2 --> V3
  V3 -->|是| V4 --> SG1
  V3 -->|否| R1
  
  V2 --> R2
  O1 --> R3
  O3 --> V1

  %% 样式定义
  classDef io fill:#E8F1FF,stroke:#1F6FEB,stroke-width:1px,color:#0B3D91;
  classDef process fill:#EAF7EE,stroke:#2E7D32,stroke-width:1px,color:#0B3D91;
  classDef decision fill:#FFF4E5,stroke:#F59E0B,stroke-width:1px,color:#7A4E00;
  classDef store fill:#F3E8FF,stroke:#8B5CF6,stroke-width:1px,color:#3B1E86;
  classDef result fill:#FDE7EF,stroke:#DB2777,stroke-width:1px,color:#7A123E;