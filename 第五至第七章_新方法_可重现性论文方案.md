## 第五章 问题一模型的建立与求解（可重现性论文格式，现行实现口径）

### 5.1 模型建立  
#### 5.1.1 问题界定与假设  
• 核心问题：在2024-2030年（7年）内，针对54个地块（露天与大棚），在满足轮作、豆类种植、销售限制、管理便利性等约束下，制定两种销售情景（超产滞销/折价销售）的最优种植方案，使总收益最大化。  
• 基本假设：
- 数据口径以附件1与附件2为准，2023年为基期；
- 地块类型与作物适应性严格遵循附件1规则；
- 豆类作物包括粮食豆类（1-5号）与蔬菜豆类（17-19号）；
- 最小作业规模：单地块单作物单季若种则面积≥max(0.5亩, 地块面积×1%)，以保障管理便利性。  

#### 5.1.2 变量与参数定义  
• 索引与集合：地块 I（54）、作物 J（1..41）、年份 T（2024..2030）、季节 S（1/2）、豆类集合 J_bean（1-5,17-19）。  
• 决策变量：x_{i,j,t,s} ≥ 0（亩）。  
• 参数：A_i（土地面积）、Y_{i,j,s}（亩产）、C_{i,j,s}（成本）、P_j（价格）、D_{j,t}（销售上限）、β_{i,j,s}（适应性0/1）、γ_i（年最大季数）。  

（符号表-问题一）

| 符号 | 含义 | 取值/来源 |
|---|---|---|
| I | 地块集合 | 附件1：54块 |
| J | 作物集合 | 附件2：1..41 |
| T | 年份集合 | 2024..2030 |
| S | 季节集合 | {1,2}（露天γ=1；水浇地/大棚γ=2） |
| J_{bean} | 豆类集合 | {1..5,17..19} |
| A_i | 地块 i 面积（亩） | 附件1 |
| γ_i | 地块 i 年最大季数 | 平旱/梯田/山坡=1；水浇地/大棚=2 |
| β_{i,j,s} | 适应性指示 | 适宜=1，不适宜=0（按附件1口径） |
| Y_{i,j,s} | 基准亩产（斤/亩） | 附件2（同类型取均值口径） |
| C_{i,j,s} | 基准成本（元/亩） | 附件2 |
| P_j | 基准单价（元/斤） | 附件2：区间均值 |
| D_{j,t} | 年销售上限（斤） | 以2023为基期口径外推（问题一为确定） |
| x_{i,j,t,s} | 地块-作物-年-季 面积（亩） | 决策变量 |
| q^{sell}_{j,t}, q^{excess}_{j,t} | 可售/超产产量（斤） | 线性化引入 |

#### 5.1.3 目标函数（两情景）  
• 情景一（超产滞销）：最大化 Σ_t Σ_j [ P_j·min(Σ_{i,s} x·Y, D_{j,t}) − Σ_{i,s} x·C ]。  
• 情景二（超产折价）：最大化 Σ_t Σ_j [ P_j·min(q_{j,t}, D_{j,t}) + 0.5P_j·max(q_{j,t}−D_{j,t},0) − Σ_{i,s} x·C ]，其中 q_{j,t}=Σ_{i,s} x·Y。  
• 线性化：以 q^{sell}_{j,t}, q^{excess}_{j,t} 满足 q = q^{sell}+q^{excess}, q^{sell}≤D, q^{excess}≥0。  

#### 5.1.4 约束条件  
1) 面积：Σ_j x_{i,j,t,s} ≤ A_i ； 2) 适应性：β_{i,j,s}=0 ⇒ x=0 ； 3) 年季数：Σ_{j,s} x_{i,j,t,s} ≤ γ_i·A_i； 4) 禁止重茬（现行实现为面积占比近似的轮作强度约束，见下“求解”）； 5) 豆类轮作（现行实现为年-地块层面的最低占比近似）； 6) 管理便利性（单地块单作物单季若种≥0.5亩；全域同作物单季总面积≥5亩以避免碎片化）。  

（管理便利性与“≥0.5或0”的线性化）

- 设二进制变量 y_{i,j,t,s}∈{0,1} 表示是否在 (i,j,t,s) 上种植，则：
  - x_{i,j,t,s} ≤ M·y_{i,j,t,s}（M 取地块面积上界）
  - x_{i,j,t,s} ≥ 0.5·y_{i,j,t,s}
  - 当 y=0 ⇒ x=0；y=1 ⇒ x≥0.5。

（禁止重茬的严格二进制表达-可选）

- 设 z_{i,j,t}∈{0,1} 表示地块 i 在年份 t 是否种作物 j（任一季），则：
  - x_{i,j,t,s} ≤ M·z_{i,j,t}，∀s；
  - z_{i,j,t} + z_{i,j,t-1} ≤ 1（同作物不连续年）；
  - 若需“同季不连续”，可替换为 z_{i,j,t,s} 并对季 s 与 s' 加禁连约束。

### 5.2 模型求解  
• 分层分治思路保留（粮食地/水浇地/大棚），但现行工程实现聚合在统一框架内输出 `result1_1.xlsx` 与 `result1_2.xlsx`：
- 粮食地块：单季主导，满足轮作近似；
- 水浇地：两季结构（季1蔬菜/稻作、季2蔬菜），按适应性与销售约束求解；
- 大棚：小面积高价值作物优先，兼顾轮作与管理便利性。  

说明：现行开源实现采用线性规划近似表达轮作强度（例如“同作物-同地块-同季在7年累积面积占比≤阈值”、豆类累计面积≥阈值），以获得稳定且可复现的可行解；若需严格0-1轮作与“3年豆类一次”的硬约束，可在问题三的扩展中追加二进制变量与Big-M线性化（见第7章“改进建议”）。  

### 5.3 结果与可重现性  
• 输出：`附件3/result1_1.xlsx`、`附件3/result1_2.xlsx`；
• 验证：适应性矩阵、轮作覆盖、管理便利性、两情景收益对比；
• 复现：固定数据源、统一口径、脚本化导出。


---

## 第六章 问题二模型的建立与求解（SAA + 内生CVaR + 分段销售，现行实现）

### 6.1 问题界定与假设  
在问题一基础上，引入参数不确定性（销量、亩产、成本、价格），采用随机规划与CVaR风险控制：
- 销量：小麦/玉米年增 U[5%,10%]；其余作物一次性波动 U[−5%,5%]；
- 亩产：U[−10%,10%]； 成本：年增5%；
- 价格：粮食稳定、蔬菜年增5%、食用菌年降[1%,5%]（羊肚菌固定降5%）。
- 风险度量：CVaR@5%，关注最坏5%情景的平均损失。  

### 6.2 变量与参数  
• 决策变量（跨情景一致）：x_{i,j,t,s}（面积）。  
• 分段销售变量（逐情景）：q^{sell}_{j,t,k}, q^{excess}_{j,t,k}。  
• CVaR内生变量：τ（VaR of loss），u_k（超额损失）满足 u_k ≥ −Profit_k − τ, u_k ≥ 0。  

#### 6.2.4 情景生成公式汇总（K=1000）

- 销量：小麦/玉米 j∈{6,7}，\( D_{j,t,k}=D_{j,2023}\cdot(1+r_{j,t,k})^{t-2023},\ r_{j,t,k}\sim U[0.05,0.10] \)；其他作物 \( D_{j,t,k}=D_{j,2023}\cdot(1+\delta_{j,t,k}),\ \delta\sim U[-0.05,0.05] \)。
- 亩产：\( Y_{i,j,t,s,k}=Y_{i,j,s}\cdot(1+\epsilon_{i,j,t,s,k}),\ \epsilon\sim U[-0.10,0.10] \)。
- 成本：\( C_{i,j,t,s,k}=C_{i,j,s}\cdot(1.05)^{t-2023} \)。
- 价格：粮食恒定；蔬菜 \( P_{j,t,k}=P_j\cdot(1.05)^{t-2023} \)；食用菌 j=41 固定年降5%，其余菇类年降 \( \mu\sim U[0.01,0.05] \)。

### 6.3 模型建立  
• 单情景收益 Profit_k：
Profit_k = Σ_t Σ_j [ P_{j,t,k}·q^{sell}_{j,t,k} + 0.5P_{j,t,k}·q^{excess}_{j,t,k} − Σ_{i,s} x·C_{i,j,t,s,k} ]，且 Σ_{i,s} x·Y_{i,j,t,s,k} = q^{sell}+q^{excess}，q^{sell}≤D_{j,t,k}。  
• 目标：最大化 E[Profit] − λ·CVaR_α(−Profit)，其中 CVaR_α(·)= τ + (1/(αN))Σ u_k。  
• 主要约束：面积、适应性、轮作近似、豆类最低占比、管理便利性（与问题一一致，但对所有情景均需满足生产-销售联立约束）。  

补充（尾部增约与近似一致性）：在代表性情景（SAA子集）上仅对“最差M个情景”施加 u_k 约束（Active-Set 迭代更新），可显著降维且与全情景CVaR近似一致；现行实现内置 `use_tail_cvar` 与 `tail_M` 控制，并支持主动集更新轮数。  

### 6.4 求解流程与工具  
• 工具：Python + PuLP(CBC)（规避商用许可限制），SAA + Monte Carlo 验证，固定随机种子确保可复现；  
• 流程：生成K=1000情景 → 选取N_saa代表性情景 → 构建MILP（含CVaR内生与分段销售）→ 求解x → 用全部K情景做稳健性验证（E、Std、VaR、CVaR）。  
• 灵敏度/稳健性：λ∈[0.7,0.8]、α∈{5%,10%}、N_saa 规模、产量与蔬价参数区间，配套绘图：
  - 图6.1 风险-收益权衡前沿（`generate_problem2_fig1_efficient_frontier.py`）
  - 图6.2 收益分布（均值/VaR/CVaR）（`generate_problem2_fig2_profit_distribution.py`）
  - 图6.3 SAA对稳健性的影响（`generate_problem2_fig3_saa_robustness.py`）
  - 图6.4 λ-α敏感性热力图（`generate_problem2_fig4_lambda_alpha_heatmap.py`）  

（伪代码）

```python
# 固定随机种子，生成 K 情景
scenarios = monte_carlo_generate(K, seed=42)
# 选择 N_saa 代表性情景（步长采样/聚类中心等）
selected = select_representative(scenarios, N_saa)
# 构建 MILP（x 跨情景共享；逐情景 q^{sell}/q^{excess}；CVaR 变量 τ,u_k）
model = build_milp(selected, lambda_risk, alpha, tail_M=None or M)
solve(model, solver='CBC', time_limit=1200, threads=4)
# 全情景验证
metrics = validate_on_all_scenarios(x_solution, scenarios)
```

（求解器与鲁棒设置）

- CBC：timeLimit=1200s，threads=4；必要时放宽或增大 N_saa；
- 数值稳健：避免在目标中直接 min/max；统一用辅助变量+线性约束；
- 复现实验：固定 seeds，输出 CSV+PNG，记录版本号与参数。

（常见异常与解决）

- Unbounded/dual infeasible：检查分段销售与成本/产量联立约束是否齐全；
- TypeError（min/max与Lp表达式混用）：改用辅助变量线性化；
- UnicodeEncodeError（Windows控制台）：`chcp 65001` 或 `python -X utf8 ...`；
- 规模过大：采用尾部增约与较小 N_saa，并进行主动集更新。

### 6.5 结果与可重现性  
• 关键结果：给出期望收益、波动率、VaR/CVaR，验证“分段销售+CVaR”的风险控制效果；
• 可重现性：固定随机种子；所有图表由脚本一键生成；CBC参数固定；输出包括CSV与PNG；
• 产出：`附件3/result2.xlsx`、图6.1-6.4及对应数据CSV。  


---

## 第七章 问题三模型的建立与求解（相关性与替代/互补，现行实现）

### 7.1 问题界定与假设  
在问题二基础上，进一步考虑：
- 作物间关系：替代（δ<0）与互补（δ>0）；
- 参数相关性：价格-销量（负）、销量-成本（正）、价格-成本（弱正）。  
采用“相关性注入 + 外层迭代修正”的两层结构，最大化“期望收益−λ·CVaR”。  

### 7.2 新增变量与参数  
• 关系系数矩阵 δ_{j,j'}（示例：西红柿-茄子−0.5；小麦-玉米−0.3；豆类-谷物+0.2）。  
• Copula 相关（目标Spearman）：ρ_PD=−0.40，ρ_DC=+0.15，ρ_PC=+0.10；映射到高斯Copula相关：ρ_G=2·sin(π·ρ_S/6)。  
• 外层迭代阻尼：θ ← (1−β)·θ + β·θ_new，β=0.5；判停：解向量相对变化<1e−3 或迭代≤10。  
• 后茬协同：若季1豆类，季2非豆类亩产×(1+5%)（验证阶段评估）。  

### 7.3 修正参数与模型  
• 修正价格：\( \tilde{P}_{j,t,k} = P_{j,t,k}\cdot \big(1 + \alpha\sum_{j'} \delta_{j,j'}\cdot S_{j',t,k}/D_{j',t,k}\big) \)。  
• 修正销量：\( \tilde{D}_{j,t,k} = D_{j,t,k}\cdot \big(1 + \rho_{PD}\cdot (P_{j,t,k}-\bar P_j)/\bar P_j + 0.2\sum_{\delta>0} S_{j',t,k}/D_{j',t,k} \big) \)。  
• 修正成本：\( \tilde{C}_{i,j,t,s,k} = C_{i,j,t,s,k}\cdot (1 + \rho_{DC}\cdot S_{j,t,k}/D_{j,t,k}) \)。  
• 目标函数与核心约束保持与问题二一致（分段销售+CVaR内生），但用修正后的\(\tilde P,\tilde D,\tilde C\)。外层循环按“固定修正→求解x→按x估算S→更新修正（带阻尼）”收敛。  

### 7.4 关系约束（政策与稳健性）  
• 强替代组占比≤40%（按年）：抑制过度集中导致的价格挤压。  
• 互补对比例≥1:3（按年）：保障协同收益。  
注：现行实现仍为面积比例约束，若需严格0-1开关可在后续版本替换为二进制变量+Big-M。  

### 7.5 求解流程与实验  
• Copula标定：固定种子，输出 `问题三_Copula标定报告.csv`（目标Spearman与拟合误差）。  
• 外层迭代：收敛判据<1e−3或≤10轮。  
• 尾部增约（可选）：仅对最差M个情景施加CVaR约束（支持主动集更新），并做M稳健性评估（`问题三_尾部增约_M稳健性.csv`）。  
• 消融实验：baseline / 仅Copula / 仅δ / both，输出 `问题三_消融实验.csv`。  
• 多种子误差带：K=1000, seeds={42,123,2024}，输出 `问题三_多随机种子误差带.csv` 与 图7.X。  
• 可视化：
  - 图7.1 作物关系热力图；
  - 图7.2 价格-供给散点（带回归与区间放大）；
  - 倒需求曲线（主粮/主菜，δ对比）；
  - 更替甘特图（Top12地块）与大棚月度利用率；
  - 问题二 vs 问题三 收益箱线图。  

脚本接口（均在根目录）：
- `run_problem3_calibration.py`（δ/ρ灵敏度与Copula标定）；
- `run_problem3_tail_robustness.py`（尾部增约M稳健性）；
- `run_problem3_ablation.py`（消融实验）；
- `run_problem3_multi_seed_band.py`（多随机种子误差带）。  

### 7.6 结果与可重现性  
• 关键结论（示例口径）：在考虑δ与相关性后，期望收益提升、波动率下降；替代作物得到抑制、互补组合面积上升；大棚吞吐利用率更均衡。  
• 产出与交付：
  - `问题三_作业清单.csv`、图7.X更替甘特图；
  - `问题三_大棚月度利用率.csv` 与图；
  - `问题三_Copula标定报告.csv`、`问题三_δρ_±20灵敏度.csv`、`问题三_消融实验.csv`、`问题三_尾部增约_M稳健性.csv`、`问题三_多随机种子误差带.csv`；
  - `问题2_vs_问题3_收益箱线图.png` 与对比表。  
• 复现要点：固定随机种子；CBC求解参数固定；所有图与表由脚本生成；路径与文件名在仓库中保持一致。  

### 7.7 与原方案差异与优势  
• 求解器：由Gurobi切换为PuLP(CBC)以解决许可限制，保证随稿复现；  
• 风险建模：内生CVaR（τ,u_k）替代外部后处理，配合尾部增约与主动集更新，规模更可控；  
• 销售刻画：分段销售（q^{sell}/q^{excess}）替代固定销售率近似，经济含义更严谨；  
• 相关性：通过高斯Copula注入秩相关，支持目标Spearman的可解释标定；  
• 工程化：提供多图多表与脚本化复现链条，评审可直接运行校验。  

### 7.8 后续可加强方向（面向国一水准）  
1) 严格0-1轮作与3年豆类周期：以二进制变量+Big-M替换当前面积占比近似；  
2) 理论一致性说明：补充尾部增约的近似一致性边界与引用；  
3) 复杂度-时间曲线：展示变量/约束规模与求解时间（含SAA/尾部增约影响）；  
4) 外样本稳健性：扩大/偏移扰动区间的Out-of-sample验证；  
5) 参数来源表与引用：补充δ与ρ的来源、区间与参考文献；  
6) 交付表：将“地块-年-季作业清单”与“大棚利用率”整理入附录表；  
7) 论文呈现：统一单位/比例尺、标注p值与效应量、补充符号表。  

---

## 附录 A：环境与运行
• 依赖：Python 3.10+；pulp、pandas、numpy、matplotlib、openpyxl  
• Windows 终端建议：`chcp 65001` 与 `python -X utf8 ...`  
• 主要脚本：
- 问题二图表：`generate_problem2_fig*.py`；
- 问题三实验：`run_problem3_*.py`；
- 一键重绘7.X图（可选）：`run_optimize_7x_figs.py`。  

## 附录 B：文件清单（部分）
- 问题二：图6.1-6.4 PNG + CSV，`附件3/result2.xlsx`
- 问题三：图7.1/7.2/倒需求/甘特/利用率/多种子误差带，及对应CSV
- 校准与实验：`问题三_Copula标定报告.csv`、`问题三_δρ_±20灵敏度.csv`、`问题三_消融实验.csv`、`问题三_尾部增约_M稳健性.csv`、`问题三_多随机种子误差带.csv`

（本文档对应现行实现：PuLP(CBC) + SAA + 内生CVaR + 分段销售 + Copula相关 + δ矩阵外层迭代；若采用更严格的0-1轮作与三年豆类周期，可在第7章“后续可加强方向”按建议扩展，以提升硬约束合规性与论文说服力。）


